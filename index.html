<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xp one.id - Inventory System</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root { --bg-body: #f3f4f6; --sidebar-bg: #111827; --primary-gradient: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); --accent-color: #f59e0b; --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        body { height: 100vh; overflow: hidden; background-color: var(--bg-body); }
        
        /* LOGIN & LAYOUT */
        #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .login-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.1); padding: 40px; width: 90%; max-width: 400px; border-radius: 20px; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); text-align: center; color: white; animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .login-logo { font-size: 2.5rem; margin-bottom: 5px; font-weight: 800; color: white; letter-spacing: 1px; } .login-logo span { color: var(--accent-color); }
        .input-group { position: relative; margin-bottom: 20px; text-align: left; } .input-group i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #9ca3af; }
        .login-input { width: 100%; padding: 14px 14px 14px 45px; background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; color: white; font-size: 0.95rem; outline: none; } .login-input:focus { border-color: var(--accent-color); background: rgba(0, 0, 0, 0.4); }
        .btn-login { width: 100%; padding: 14px; background: var(--primary-gradient); border: none; border-radius: 10px; color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: 0.3s; margin-top: 10px; }

        #app-container { display: none; height: 100vh; width: 100%; } #app-container.active { display: flex; }
        .sidebar { width: 260px; background: var(--sidebar-bg); color: white; display: flex; flex-direction: column; border-right: 1px solid #374151; }
        .brand { padding: 25px; font-size: 1.6rem; font-weight: 800; text-align: center; color: white; margin-bottom: 20px; } .brand span { color: var(--accent-color); }
        .menu { flex: 1; padding: 0 15px; overflow-y: auto; } .nav-link { display: flex; align-items: center; padding: 14px 15px; margin-bottom: 8px; color: #9ca3af; text-decoration: none; border-radius: 10px; cursor: pointer; transition: 0.3s; font-weight: 500; } .nav-link:hover, .nav-link.active { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: translateX(5px); } .nav-link i { margin-right: 15px; width: 20px; text-align: center; font-size: 1.1rem; }
        .logout-btn { margin: 15px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 10px; color: #ef4444; text-align: center; cursor: pointer; font-weight: 600; border: 1px solid rgba(239, 68, 68, 0.2); } .logout-btn:hover { background: #ef4444; color: white; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; position: relative; background: #f9fafb; }
        .page-header { margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; } .page-header h2 { font-size: 1.8rem; color: #111827; font-weight: 700; }
        .user-info { font-size: 0.9rem; color: #4b5563; font-weight: 500; background: white; padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .section { display: none; animation: fadeIn 0.4s ease-out; } .section.active { display: block; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* COMPONENTS */
        .stats-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .stat-card { padding: 25px; border-radius: 16px; color: white; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .bg-gradient-1 { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); } .bg-gradient-2 { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); } .bg-gradient-3 { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .stat-card h3 { font-size: 2.5rem; font-weight: 700; margin-bottom: 5px;}
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 30px; } @media (max-width: 992px) { .charts-grid { grid-template-columns: 1fr; } }
        .chart-card { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--card-shadow); display:flex; flex-direction:column; align-items:center; } .chart-container { position: relative; height: 300px; width: 100%; display: flex; justify-content: center; }

        .card { background: white; padding: 25px; border-radius: 16px; box-shadow: var(--card-shadow); margin-bottom: 20px; overflow-x: auto; border: 1px solid #e5e7eb; }
        .form-group { margin-bottom: 20px; } label { display: block; margin-bottom: 8px; font-weight: 600; color: #374151; font-size: 0.9rem; } .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; background: #f9fafb; } input:focus, select:focus { border-color: #2563eb; outline: none; background: white; } input[readonly] { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        button { padding: 12px 25px; border: none; border-radius: 8px; color: white; font-weight: 600; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-primary { background: var(--primary-gradient); } .btn-success { background: linear-gradient(90deg, #10b981, #059669); } .btn-danger { background: linear-gradient(90deg, #ef4444, #dc2626); } .btn-dark { background: #1f2937; color: white; } .btn-warning { background: #f59e0b; color: white; } button:hover { opacity: 0.95; transform: translateY(-1px); }
        .btn-sm { padding: 8px 12px; font-size: 0.85rem; border-radius: 8px; margin: 0 2px; }

        .filter-container { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #e5e7eb; display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; } .filter-item { flex: 1; min-width: 150px; } .filter-date-group { display: flex; gap: 10px; flex: 2; min-width: 300px; } .filter-date-group .filter-item { flex:1; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px; min-width: 800px; } th { background: #f9fafb; padding: 15px; text-align: left; color: #374151; font-weight: 700; border-bottom: 2px solid #e5e7eb; font-size: 0.85rem; } td { padding: 15px; border-bottom: 1px solid #f3f4f6; color: #1f2937; vertical-align: middle; font-size: 0.9rem; }
        
        /* SETTING LAYOUT REDESIGN */
        .setting-wrapper { display: flex; flex-direction: column; gap: 20px; }
        .setting-row-top { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .setting-row-full { width: 100%; }
        .setting-row-bottom { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .setting-row-top, .setting-row-bottom { grid-template-columns: 1fr; } }

        .profile-hero { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #f3f4f6; }
        .profile-avatar-lg { width: 70px; height: 70px; border-radius: 50%; background: var(--primary-gradient); color: white; font-size: 2rem; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(3px); } .modal-overlay.active { display: flex; animation: fadeIn 0.2s; } .modal-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); } .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; } .close-modal { background: none; color: #6b7280; font-size: 1.5rem; padding: 0; box-shadow: none; }
        
        @media (max-width: 768px) { body { flex-direction: column; overflow-y: auto; } .sidebar { display: none; } .main-content { padding: 20px; padding-bottom: 80px; } .mobile-nav { display: flex; position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 10px; justify-content: space-around; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); z-index: 99; border-top: 1px solid #e5e7eb; } .mobile-nav .nav-link { flex-direction: column; font-size: 0.6rem; padding: 5px; margin: 0; background: none; color: #6b7280; box-shadow: none; } .mobile-nav .nav-link.active { color: #2563eb; } .mobile-nav i { font-size: 1.2rem; margin-bottom: 3px;} .filter-date-group { flex-direction: column; } } @media (min-width: 769px) { .mobile-nav { display: none; } }
    </style>
</head>
<body>

    <div id="login-section">
        <div class="login-card">
            <div class="login-logo">Xp one<span>.id</span></div>
            <p class="login-subtitle">Masukkan akun untuk mengakses sistem (MySQL)</p>
            <form onsubmit="event.preventDefault(); prosesLogin();">
                <div class="input-group"><input type="text" id="username" class="login-input" placeholder="Username" required><i class="fas fa-user"></i></div>
                <div class="input-group"><input type="password" id="password" class="login-input" placeholder="Password" required><i class="fas fa-lock"></i></div>
                <button type="submit" class="btn-login">Masuk System <i class="fas fa-arrow-right" style="margin-left:5px"></i></button>
            </form>
        </div>
    </div>

    <div id="app-container">
        <div class="sidebar">
            <div class="brand">Xp one<span>.id</span></div>
            <nav class="menu">
                <div class="nav-link active" onclick="navigasi('dashboard', this)"><i class="fas fa-chart-pie"></i> <span>Dashboard</span></div>
                <div class="nav-link" onclick="navigasi('barang-baru', this)"><i class="fas fa-box"></i> <span>Input Barang Baru</span></div>
                <div class="nav-link" onclick="navigasi('barang-masuk', this)"><i class="fas fa-dolly"></i> <span>Barang Masuk</span></div>
                <div class="nav-link" onclick="navigasi('barang-keluar', this)"><i class="fas fa-truck-loading"></i> <span>Barang Keluar</span></div>
                <div class="nav-link" onclick="navigasi('laporan', this)"><i class="fas fa-file-invoice"></i> <span>Laporan & Aset</span></div>
                <div id="nav-setting-side" class="nav-link" onclick="navigasi('setting', this)"><i class="fas fa-cog"></i> <span>Seting</span></div>
            </nav>
            <div class="logout-btn" onclick="prosesLogout()"><i class="fas fa-power-off"></i> Keluar</div>
        </div>

        <div class="main-content">
            
            <div id="dashboard" class="section active">
                <div class="page-header"><h2>Dashboard Utama</h2><div class="user-info" id="user-display">User</div></div>
                <div class="stats-container">
                    <div class="stat-card bg-gradient-1"><h3 id="dash-jenis">0</h3><p>Jenis Barang</p></div>
                    <div class="stat-card bg-gradient-2"><h3 id="dash-total">0</h3><p>Total Unit Stok</p></div>
                    <div class="stat-card bg-gradient-3"><h3 id="dash-aset">Rp 0</h3><p>Nilai Aset</p></div>
                </div>
                <div class="charts-grid">
                    <div class="chart-card"><h3>Stok per Barang</h3><div class="chart-container"><canvas id="myPieChart"></canvas></div></div>
                    <div class="chart-card"><h3>Komposisi Aset</h3><div class="chart-container"><canvas id="myDoughnutChart"></canvas></div></div>
                </div>
            </div>

            <div id="barang-baru" class="section">
                <div class="page-header"><h2>Input Barang Baru</h2></div>
                <div class="card" style="max-width: 600px; margin: 0 auto; border-top: 4px solid #3b82f6;">
                    <div class="form-row"><div class="form-group"><label>Tanggal Input</label><input type="date" id="baru_tgl"></div><div class="form-group"><label>ID (Otomatis)</label><input type="text" id="baru_id" readonly style="font-weight:bold; color:#2563eb"></div></div>
                    <div class="form-group"><label>Nama Barang</label><input type="text" id="baru_nama" placeholder="Nama item..."></div>
                    <div class="form-row"><div class="form-group"><label>Satuan</label><input type="text" id="baru_satuan" placeholder="Pcs/Dus"></div><div class="form-group"><label>Harga Awal (Rp)</label><input type="number" id="baru_harga"></div></div>
                    <div class="form-group"><label>Stok Awal</label><input type="number" id="baru_stok" value="0"></div>
                    <button class="btn-primary" style="width:100%" onclick="tambahBarang()"><i class="fas fa-save"></i> Simpan Data</button>
                </div>
            </div>

            <div id="barang-masuk" class="section">
                <div class="page-header"><h2>Barang Masuk</h2></div>
                <div class="card" style="max-width: 700px; margin: 0 auto;">
                    <div class="form-group"><label>Tanggal</label><input type="date" id="masuk_tgl"></div>
                    <div class="form-group"><label>Pilih Barang</label><select id="masuk_id" class="select-barang" onchange="autoFillSatuan(this.value)"></select></div>
                    <div class="form-row"><div class="form-group"><label>Satuan</label><input type="text" id="masuk_satuan" placeholder="Auto" readonly></div><div class="form-group"><label>Jumlah (Qty)</label><input type="number" id="masuk_qty" value="1"></div></div>
                    <div class="form-group"><label>Harga Beli Baru</label><input type="number" id="masuk_harga"></div>
                    <button class="btn-success" style="width:100%" onclick="transaksiMasuk()">Simpan Stok Masuk</button>
                </div>
                <div class="card">
                    <h3>Riwayat Masuk</h3>
                    <div class="filter-container">
                        <div class="filter-date-group"><div class="filter-item"><label>Dari Tgl</label><input type="date" id="filter_masuk_start" onchange="renderRiwayatMasuk()"></div><div class="filter-item"><label>Sampai Tgl</label><input type="date" id="filter_masuk_end" onchange="renderRiwayatMasuk()"></div></div>
                        <div class="filter-item"><label>Cari Nama</label><input type="text" id="filter_masuk_keyword" onkeyup="renderRiwayatMasuk()" placeholder="Ketik nama..."></div>
                        <div class="filter-item" style="flex:0"><button onclick="resetFilterMasuk()" class="btn-warning"><i class="fas fa-sync"></i></button></div>
                        <div class="filter-item" style="flex:0"><button onclick="cetakPDFMasuk()" class="btn-dark"><i class="fas fa-print"></i> PDF</button></div>
                    </div>
                    <table id="tabel-riwayat-masuk"><thead><tr><th>Tgl</th><th>Nama</th><th>Qty</th><th>Total</th><th>Aksi</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <div id="barang-keluar" class="section">
                <div class="page-header"><h2>Barang Keluar</h2></div>
                <div class="card" style="max-width: 600px; margin: 0 auto;">
                    <div class="form-group"><label>Tanggal</label><input type="date" id="keluar_tgl"></div>
                    <div class="form-group"><label>Pilih Barang</label><select id="keluar_id" class="select-barang"></select></div>
                    <div class="form-group"><label>Jumlah Keluar</label><input type="number" id="keluar_qty" value="1"></div>
                    <div class="form-group"><label>Keperluan</label><input type="text" id="keluar_ket"></div>
                    <button class="btn-danger" style="width:100%" onclick="transaksiKeluar()">Proses Keluar</button>
                </div>
                <div class="card">
                    <h3>Riwayat Keluar</h3>
                    <div class="filter-container">
                        <div class="filter-date-group"><div class="filter-item"><label>Dari Tgl</label><input type="date" id="filter_keluar_start" onchange="renderRiwayatKeluar()"></div><div class="filter-item"><label>Sampai Tgl</label><input type="date" id="filter_keluar_end" onchange="renderRiwayatKeluar()"></div></div>
                        <div class="filter-item"><label>Cari Nama</label><input type="text" id="filter_keluar_keyword" onkeyup="renderRiwayatKeluar()" placeholder="Ketik nama..."></div>
                        <div class="filter-item" style="flex:0"><button onclick="resetFilterKeluar()" class="btn-warning"><i class="fas fa-sync"></i></button></div>
                        <div class="filter-item" style="flex:0"><button onclick="cetakPDFKeluar()" class="btn-dark"><i class="fas fa-print"></i> PDF</button></div>
                    </div>
                    <table id="tabel-riwayat-keluar"><thead><tr><th>Tgl</th><th>Nama</th><th>Qty</th><th>Keperluan</th><th>Aksi</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <div id="laporan" class="section">
                <div class="page-header"><h2>Laporan & Aset</h2></div>
                <div style="margin-bottom:15px;"><button onclick="cetakPDFLaporan()" class="btn-dark"><i class="fas fa-print"></i> Cetak PDF Laporan</button></div>
                <div class="card">
                    <table id="tabel-stok"><thead><tr><th>ID</th><th>Nama Barang</th><th>Stok</th><th>Harga</th><th>Total Aset</th><th>Aksi</th></tr></thead><tbody></tbody></table>
                </div>
            </div>

            <div id="setting" class="section">
                <div class="page-header"><h2>Pengaturan Sistem</h2></div>
                
                <div class="setting-wrapper">
                    <div class="setting-row-top">
                        <div class="card" id="profile-card-display" style="margin-bottom:0">
                            <div class="profile-hero">
                                <div class="profile-avatar-lg" id="prof-ava">A</div>
                                <div>
                                    <h3 style="color:#111827; font-size:1.2rem; margin:0" id="prof-name-disp">Admin</h3>
                                    <span style="color:#6b7280; font-size:0.9rem" id="prof-role-disp">@admin</span>
                                </div>
                            </div>
                            <div style="font-size:0.85rem; color:#6b7280;">
                                Status: <strong id="prof-role-badge" style="color:#2563eb">Administrator</strong>
                            </div>
                        </div>

                        <div class="card" style="margin-bottom:0">
                            <h3 style="color:#2563eb"><i class="fas fa-barcode"></i> Prefix ID Barang</h3>
                            <p style="font-size:0.8rem; color:#6b7280; margin-bottom:15px">Mengatur huruf depan kode barang otomatis.</p>
                            <div style="display:flex; gap:10px;">
                                <input type="text" id="setting_prefix" placeholder="XP" style="flex:1" value="XP">
                                <button class="btn-primary" onclick="simpanPrefixID()">Simpan</button>
                            </div>
                        </div>
                    </div>

                    <div class="card setting-row-full">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="color:#2563eb; margin:0;"><i class="fas fa-users-cog"></i> Manajemen Pengguna</h3>
                            <button id="btn-add-user" onclick="bukaModalAddUser()" class="btn-success btn-sm" style="display:none"><i class="fas fa-plus"></i> Tambah User</button>
                        </div>
                        <div style="overflow-x:auto">
                            <table id="tbl_users" style="min-width:100%">
                                <thead>
                                    <tr>
                                        <th>Nama Lengkap</th>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th style="text-align:right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="setting-row-bottom">
                        <div id="admin-panel-backup" class="card" style="display:none; margin-bottom:0; border-top: 4px solid #10b981;">
                            <h3 style="color:#10b981"><i class="fas fa-database"></i> Backup & Restore</h3>
                            <p style="font-size:0.8rem; color:#6b7280; margin:10px 0;">Amankan data database ke file JSON.</p>
                            <div style="display:flex; gap:10px;">
                                <button onclick="backupDatabase()" class="btn-primary" style="flex:1; background:#0f766e"><i class="fas fa-download"></i> Backup</button>
                                <button onclick="triggerRestore()" class="btn-warning" style="flex:1; background:#f59e0b"><i class="fas fa-upload"></i> Restore</button>
                            </div>
                            <input type="file" id="file_restore" style="display:none" accept=".json" onchange="processRestore(this)">
                        </div>

                        <div id="admin-panel-reset" class="card" style="border: 1px solid #fecaca; background: #fef2f2; display:none; margin-bottom:0;">
                            <h3 style="color:#dc2626"><i class="fas fa-exclamation-triangle"></i> Zona Bahaya</h3>
                            <p style="font-size:0.8rem; color:#b91c1c; margin:10px 0;">Menghapus seluruh data transaksi & barang.</p>
                            <button onclick="resetData()" class="btn-danger" style="width:100%"><i class="fas fa-trash"></i> Reset All Data System</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mobile-nav">
            <div class="nav-link active" onclick="navigasi('dashboard', this)"><i class="fas fa-home"></i> Home</div>
            <div class="nav-link" onclick="navigasi('barang-masuk', this)"><i class="fas fa-arrow-down"></i> Masuk</div>
            <div class="nav-link" onclick="navigasi('barang-keluar', this)"><i class="fas fa-arrow-up"></i> Keluar</div>
            <div class="nav-link" onclick="navigasi('laporan', this)"><i class="fas fa-list"></i> Data</div>
            <div id="nav-setting-mobile" class="nav-link" onclick="navigasi('setting', this)"><i class="fas fa-cog"></i> Seting</div>
        </div>
    </div>

    <div id="modalEdit" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3>Edit Master Barang</h3><button class="close-modal" onclick="tutupModal('modalEdit')">&times;</button></div><input type="hidden" id="edit_id"><div class="form-group"><label>Nama</label><input type="text" id="edit_nama"></div><div class="form-group"><label>Harga</label><input type="number" id="edit_harga"></div><div class="form-group"><label>Stok</label><input type="number" id="edit_stok"></div><button class="btn-primary" style="width:100%" onclick="simpanEdit()">Update</button></div></div>
    
    <div id="modalEditMasuk" class="modal-overlay"><div class="modal-box" style="border-top:5px solid #10b981;"><div class="modal-header"><h3 style="color:#10b981">Edit Riwayat Masuk</h3><button class="close-modal" onclick="tutupModal('modalEditMasuk')">&times;</button></div><input type="hidden" id="em_id_trx"><div class="form-group"><label>Tanggal</label><input type="date" id="em_tgl"></div><div class="form-group"><label>Qty</label><input type="number" id="em_qty"></div><div class="form-group"><label>Harga Beli</label><input type="number" id="em_harga"></div><p style="font-size:0.8rem;color:#ef4444;margin-bottom:10px">Perubahan Qty update stok otomatis.</p><button class="btn-success" style="width:100%" onclick="simpanEditMasuk()">Simpan</button></div></div>

    <div id="modalEditKeluar" class="modal-overlay"><div class="modal-box" style="border-top:5px solid #ef4444;"><div class="modal-header"><h3 style="color:#ef4444">Edit Riwayat Keluar</h3><button class="close-modal" onclick="tutupModal('modalEditKeluar')">&times;</button></div><input type="hidden" id="ek_id_trx"><div class="form-group"><label>Tanggal</label><input type="date" id="ek_tgl"></div><div class="form-group"><label>Qty</label><input type="number" id="ek_qty"></div><div class="form-group"><label>Keperluan</label><input type="text" id="ek_ket"></div><p style="font-size:0.8rem;color:#ef4444;margin-bottom:10px">Perubahan Qty update stok otomatis.</p><button class="btn-danger" style="width:100%" onclick="simpanEditKeluar()">Simpan</button></div></div>

    <div id="modalProfile" class="modal-overlay"><div class="modal-box" style="border-top:5px solid #f59e0b;"><div class="modal-header"><h3 style="color:#f59e0b">Edit Profil Saya</h3><button class="close-modal" onclick="tutupModal('modalProfile')">&times;</button></div><div class="form-group"><label>Nama Lengkap</label><input type="text" id="prof_name"></div><div class="form-group"><label>Username</label><input type="text" id="prof_user"></div><div class="form-group"><label>Password</label><input type="text" id="prof_pass"></div><button class="btn-primary" style="width:100%;background:#f59e0b" onclick="simpanProfil()">Simpan</button></div></div>
    
    <div id="modalEditUserAdmin" class="modal-overlay"><div class="modal-box" style="border-top:5px solid #2563eb;"><div class="modal-header"><h3 style="color:#2563eb">Edit User (Admin Mode)</h3><button class="close-modal" onclick="tutupModal('modalEditUserAdmin')">&times;</button></div><input type="hidden" id="eua_old_username"><div class="form-group"><label>Nama Lengkap</label><input type="text" id="eua_name"></div><div class="form-group"><label>Username</label><input type="text" id="eua_user"></div><div class="form-group"><label>Password Baru</label><input type="text" id="eua_pass"></div><button class="btn-primary" style="width:100%" onclick="simpanEditUserAdmin()">Update User Database</button></div></div>

    <div id="modalAddUser" class="modal-overlay"><div class="modal-box"><div class="modal-header"><h3>Tambah User Baru</h3><button class="close-modal" onclick="tutupModal('modalAddUser')">&times;</button></div><div class="form-group"><label>Username</label><input type="text" id="new_username"></div><div class="form-group"><label>Password</label><input type="text" id="new_password"></div><div class="form-group"><label>Nama Lengkap</label><input type="text" id="new_fullname"></div><button class="btn-success" style="width:100%" onclick="tambahUser()">Simpan User</button></div></div>

<script>
    let db=[], historyMasuk=[], historyKeluar=[], usersDb=[];
    let appSettings=JSON.parse(localStorage.getItem('app_settings'))||{id_prefix:'XP'};
    let currentUser=null, pieChart=null, donutChart=null;
    const {jsPDF}=window.jspdf; const colors=['#3b82f6','#8b5cf6','#10b981','#f59e0b','#ef4444','#ec4899','#06b6d4'];

    window.onload=function(){
        const t=new Date().toISOString().split('T')[0];
        ['masuk_tgl','keluar_tgl','baru_tgl'].forEach(id=>{if(document.getElementById(id))document.getElementById(id).value=t;});
        document.getElementById('setting_prefix').value=appSettings.id_prefix;
        const s=localStorage.getItem('activeUser');
        if(s){currentUser=JSON.parse(s); loadDataFromServer();} else showLogin();
    };

    async function api(act,data={}){
        try{const r=await fetch('api.php?action='+act,{method:'POST',body:JSON.stringify(data)});return await r.json();}
        catch(e){console.error(e);alert("Gagal koneksi Server.");return{status:'error'};}
    }

    async function loadDataFromServer(){
        const d=await api('get_all_data');
        if(d){ db=d.db_stok||[]; historyMasuk=d.history_masuk||[]; historyKeluar=d.history_keluar||[]; usersDb=d.users||[]; showApp(); }
    }

    async function prosesLogin(){
        const u=document.getElementById('username').value; const p=document.getElementById('password').value;
        const res=await api('login',{username:u,password:p});
        if(res.status==='success'){ currentUser=res.data; localStorage.setItem('activeUser',JSON.stringify(currentUser)); loadDataFromServer(); }
        else alert(res.msg||"Gagal");
    }
    
    function showLogin(){document.getElementById('login-section').style.display='flex';document.getElementById('app-container').classList.remove('active');}
    function showApp(){
        document.getElementById('login-section').style.display='none'; document.getElementById('app-container').classList.add('active');
        document.getElementById('user-display').innerHTML=`<i class="fas fa-user-circle"></i> ${currentUser.name}`;
        
        const isAdmin=currentUser.role==='admin'||currentUser.username==='admin';
        document.getElementById('btn-add-user').style.display=isAdmin?'block':'none';
        document.getElementById('admin-panel-reset').style.display=isAdmin?'block':'none';
        document.getElementById('admin-panel-backup').style.display=isAdmin?'block':'none';
        
        document.getElementById('prof-ava').innerText=currentUser.name.charAt(0).toUpperCase();
        document.getElementById('prof-name-disp').innerText=currentUser.name;
        document.getElementById('prof-role-disp').innerText='@'+currentUser.username;
        document.getElementById('prof-role-badge').innerText=isAdmin?'Administrator':'Staff User';
        render();
    }
    function prosesLogout(){localStorage.removeItem('activeUser');location.reload();}
    function tutupModal(id){document.getElementById(id).classList.remove('active');}

    // --- BACKUP & RESTORE FUNCTIONS ---
    async function backupDatabase() {
        const res = await api('backup_data');
        if(res) {
            const blob = new Blob([JSON.stringify(res, null, 2)], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = "Backup_Inventory_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
    }
    function triggerRestore() { document.getElementById('file_restore').click(); }
    function processRestore(elm) {
        const file = elm.files[0]; if(!file) return;
        if(!confirm("PERINGATAN: Data saat ini akan DIHAPUS dan diganti dengan data backup. Lanjutkan?")) { elm.value=''; return; }
        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const json = JSON.parse(e.target.result);
                const res = await api('restore_data', json);
                if(res.status === 'success') { alert("Data Berhasil Direstore! Halaman akan dimuat ulang."); location.reload(); } 
                else { alert("Gagal restore."); }
            } catch(err) { alert("File JSON tidak valid!"); }
        };
        reader.readAsText(file);
    }

    // --- PROFIL & USER ---
    function bukaModalProfile(){ document.getElementById('prof_name').value=currentUser.name; document.getElementById('prof_user').value=currentUser.username; document.getElementById('prof_pass').value=currentUser.password; document.getElementById('modalProfile').classList.add('active'); }
    async function simpanProfil(){
        const data={username_lama:currentUser.username, username_baru:document.getElementById('prof_user').value, password:document.getElementById('prof_pass').value, name:document.getElementById('prof_name').value};
        if(!data.username_baru||!data.password)return alert("Wajib diisi");
        if((await api('edit_profile',data)).status==='success'){ alert("Update sukses, login ulang."); prosesLogout(); } else alert("Gagal update");
    }
    function bukaModalAddUser(){document.getElementById('modalAddUser').classList.add('active');}
    async function tambahUser(){
        const u=document.getElementById('new_username').value, p=document.getElementById('new_password').value, n=document.getElementById('new_fullname').value;
        if(u&&p){ if((await api('tambah_user',{username:u,password:p,name:n})).status==='success'){ alert('User ditambahkan'); tutupModal('modalAddUser'); document.getElementById('new_username').value=''; loadDataFromServer(); }}
    }
    
    // ADMIN BISA EDIT SIAPA SAJA
    function editUserAdmin(uname){
        const u = usersDb.find(x => x.username === uname);
        if(u){ document.getElementById('eua_old_username').value = u.username; document.getElementById('eua_user').value = u.username; document.getElementById('eua_name').value = u.name; document.getElementById('eua_pass').value = u.password; document.getElementById('modalEditUserAdmin').classList.add('active'); }
    }
    async function simpanEditUserAdmin(){
        const data = { username_lama: document.getElementById('eua_old_username').value, username_baru: document.getElementById('eua_user').value, password: document.getElementById('eua_pass').value, name: document.getElementById('eua_name').value };
        const res = await api('update_user_admin', data);
        if(res.status==='success'){ 
            alert("User Berhasil Diupdate"); 
            tutupModal('modalEditUserAdmin'); 
            // Jika admin mengedit dirinya sendiri di tabel, harus relogin/refresh data local
            if(data.username_lama === currentUser.username) {
                alert("Anda baru saja mengubah akun Anda sendiri. Silakan login ulang.");
                prosesLogout();
            } else {
                loadDataFromServer(); 
            }
        } else alert("Gagal");
    }
    async function hapusUser(u){if(confirm('Hapus user '+u+'?')){await api('hapus_user',{username:u});loadDataFromServer();}}

    // --- RENDER ---
    function render(){
        document.getElementById('baru_id').value=generateId();
        let opt='<option value="">-- Pilih --</option>'; db.forEach(x=>opt+=`<option value="${x.id}">${x.nama} (Stok: ${x.stok})</option>`); document.querySelectorAll('.select-barang').forEach(e=>e.innerHTML=opt);
        document.querySelector('#tabel-stok tbody').innerHTML=db.length?db.map(x=>`<tr><td style="color:#2563eb;font-weight:bold">${x.id}</td><td>${x.nama}</td><td><span style="color:${x.stok<10?'red':'green'};font-weight:bold">${x.stok} ${x.satuan}</span></td><td>${formatRupiah(x.harga)}</td><td>${formatRupiah(x.stok*x.harga)}</td><td><button class="btn-warning btn-sm" onclick="editBarang('${x.id}')"><i class="fas fa-pen"></i></button> <button class="btn-danger btn-sm" onclick="hapusBarang('${x.id}')"><i class="fas fa-trash"></i></button></td></tr>`).join(''):'<tr><td colspan="6" align="center">Kosong</td></tr>';
        document.getElementById('dash-jenis').innerText=db.length; document.getElementById('dash-total').innerText=db.reduce((a,b)=>a+b.stok,0); document.getElementById('dash-aset').innerText=formatRupiah(db.reduce((a,b)=>a+(b.stok*b.harga),0));
        renderRiwayatMasuk(); renderRiwayatKeluar(); renderUsers(); updateCharts();
    }
    function renderUsers(){
        const tbody=document.querySelector('#tbl_users tbody');
        // TAMPILKAN SEMUA USER (Termasuk Admin) karena requestnya Admin mau edit semuanya
        tbody.innerHTML = usersDb.map(u => {
            const isMe = u.username === currentUser.username;
            const isAdmin = currentUser.role === 'admin' || currentUser.username === 'admin';
            let btn = '';
            
            if (isAdmin) {
                // Admin bisa edit SIAPA SAJA (termasuk dirinya)
                btn += `<button onclick="editUserAdmin('${u.username}')" class="btn-warning btn-sm"><i class="fas fa-pen"></i> Edit</button> `;
                // Admin TIDAK BISA hapus dirinya sendiri di tombol ini (Safety)
                if(!isMe) btn += `<button onclick="hapusUser('${u.username}')" class="btn-danger btn-sm"><i class="fas fa-trash"></i> Hapus</button>`;
            } else if (isMe) {
                // User biasa cuma bisa edit diri sendiri (via modal profile)
                btn = `<button onclick="bukaModalProfile()" class="btn-warning btn-sm"><i class="fas fa-user-edit"></i> Edit Profil</button>`;
            } else {
                btn = `<span style="color:#ccc; font-size:0.8rem"><i>No Access</i></span>`;
            }

            return `<tr>
                <td style="font-weight:600;color:#374151">${u.name} ${isMe?'<span style="background:#dbeafe;color:#1e40af;font-size:0.7rem;padding:2px 6px;border-radius:4px">You</span>':''}</td>
                <td style="color:#6b7280">@${u.username}</td>
                <td><span style="font-size:0.8rem; background:${u.role==='admin'?'#dbeafe':'#f3f4f6'}; color:${u.role==='admin'?'#1e40af':'#374151'}; padding:2px 8px; border-radius:10px">${u.role||'user'}</span></td>
                <td style="text-align:right">${btn}</td>
            </tr>`;
        }).join('');
    }
    function renderRiwayatMasuk(){const k=document.getElementById('filter_masuk_keyword').value.toLowerCase(); const s=document.getElementById('filter_masuk_start').value; const e=document.getElementById('filter_masuk_end').value; const d=historyMasuk.filter(x=>x.nama_barang.toLowerCase().includes(k)&&isDateInRange(x.tgl,s,e)); document.querySelector('#tabel-riwayat-masuk tbody').innerHTML=d.map(x=>`<tr><td>${x.tgl}</td><td>${x.nama_barang}</td><td>${x.qty} ${x.satuan}</td><td>${formatRupiah(x.total||0)}</td><td><button class="btn-warning btn-sm" onclick="editRiwayatMasuk('${x.id_transaksi}')"><i class="fas fa-pen"></i></button> <button class="btn-danger btn-sm" onclick="hapusRiwayatMasuk('${x.id_transaksi}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');}
    function renderRiwayatKeluar(){const k=document.getElementById('filter_keluar_keyword').value.toLowerCase(); const s=document.getElementById('filter_keluar_start').value; const e=document.getElementById('filter_keluar_end').value; const d=historyKeluar.filter(x=>x.nama_barang.toLowerCase().includes(k)&&isDateInRange(x.tgl,s,e)); document.querySelector('#tabel-riwayat-keluar tbody').innerHTML=d.map(x=>`<tr><td>${x.tgl}</td><td>${x.nama_barang}</td><td>${x.qty} ${x.satuan}</td><td>${x.ket}</td><td><button class="btn-warning btn-sm" onclick="editRiwayatKeluar('${x.id_transaksi}')"><i class="fas fa-pen"></i></button> <button class="btn-danger btn-sm" onclick="hapusRiwayatKeluar('${x.id_transaksi}')"><i class="fas fa-trash"></i></button></td></tr>`).join('');}
    function updateCharts(){const P=document.getElementById('myPieChart').getContext('2d'),D=document.getElementById('myDoughnutChart').getContext('2d'),l=db.map(x=>x.nama),d=db.map(x=>x.stok),b=db.map((_,i)=>colors[i%colors.length]);if(pieChart)pieChart.destroy();if(donutChart)donutChart.destroy();pieChart=new Chart(P,{type:'pie',data:{labels:l,datasets:[{data:d,backgroundColor:b}]},options:{maintainAspectRatio:false}});donutChart=new Chart(D,{type:'doughnut',data:{labels:l,datasets:[{data:d,backgroundColor:b}]},options:{maintainAspectRatio:false,cutout:'60%'}});}
    
    // --- HELPER ---
    function formatRupiah(n){return new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0}).format(n);}
    function isDateInRange(d,s,e){if(!s&&!e)return true;const t=new Date(d),st=s?new Date(s):new Date('1970'),en=e?new Date(e):new Date('2100');return t>=st&&t<=en;}
    function navigasi(id,elm){document.querySelectorAll('.section').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.nav-link').forEach(x=>x.classList.remove('active'));document.getElementById(id).classList.add('active');if(elm)elm.classList.add('active');render();}
    function simpanPrefixID(){ appSettings.id_prefix=document.getElementById('setting_prefix').value.trim().toUpperCase()||'XP'; localStorage.setItem('app_settings',JSON.stringify(appSettings)); render(); alert('Prefix tersimpan!'); }
    function generateId(){ const p=appSettings.id_prefix; let m=0; db.forEach(i=>{const n=parseInt(i.id.replace(/\D/g,''));if(n>m)m=n;}); return p+String(m+1).padStart(3,'0'); }
    async function tambahBarang(){const d={id:document.getElementById('baru_id').value, nama:document.getElementById('baru_nama').value, satuan:document.getElementById('baru_satuan').value||'Pcs', harga:parseInt(document.getElementById('baru_harga').value)||0, stok:parseInt(document.getElementById('baru_stok').value)||0, tgl_masuk:document.getElementById('baru_tgl').value}; if(!d.nama)return alert('Nama wajib'); if((await api('tambah_barang',d)).status==='success'){alert('Berhasil');document.getElementById('baru_nama').value='';document.getElementById('baru_stok').value='0';loadDataFromServer();}else alert("Gagal"); }
    async function hapusBarang(id){if(confirm('Hapus?')){await api('hapus_barang',{id:id});loadDataFromServer();}}
    function editBarang(id){const i=db.find(x=>x.id===id);if(i){document.getElementById('edit_id').value=i.id;document.getElementById('edit_nama').value=i.nama;document.getElementById('edit_harga').value=i.harga;document.getElementById('edit_stok').value=i.stok;document.getElementById('modalEdit').classList.add('active');}}
    async function simpanEdit(){await api('update_barang',{id:document.getElementById('edit_id').value, nama:document.getElementById('edit_nama').value, harga:document.getElementById('edit_harga').value, stok:document.getElementById('edit_stok').value});loadDataFromServer();tutupModal('modalEdit');}
    function autoFillSatuan(id){const i=db.find(x=>x.id==id);if(i)document.getElementById('masuk_satuan').value=i.satuan;}
    async function transaksiMasuk(){const id=document.getElementById('masuk_id').value, qty=parseInt(document.getElementById('masuk_qty').value), h=parseInt(document.getElementById('masuk_harga').value); const i=db.find(x=>x.id==id); if(!id||qty<=0)return alert('Invalid'); const d={id_transaksi:'IN-'+Date.now(), tgl:document.getElementById('masuk_tgl').value, id:id, nama:i.nama, qty:qty, satuan:i.satuan, harga:h||i.harga, total:qty*(h||i.harga)}; if((await api('transaksi_masuk',d)).status==='success'){alert('Sukses');loadDataFromServer();}}
    async function transaksiKeluar(){const id=document.getElementById('keluar_id').value, qty=parseInt(document.getElementById('keluar_qty').value); const i=db.find(x=>x.id==id); if(!id||qty<=0)return alert('Invalid'); if(i.stok<qty)return alert('Stok kurang'); const d={id_transaksi:'OUT-'+Date.now(), tgl:document.getElementById('keluar_tgl').value, id:id, nama:i.nama, qty:qty, satuan:i.satuan, ket:document.getElementById('keluar_ket').value}; if((await api('transaksi_keluar',d)).status==='success'){alert('Sukses');loadDataFromServer();}}
    function editRiwayatMasuk(id){const h=historyMasuk.find(x=>x.id_transaksi===id);if(h){document.getElementById('em_id_trx').value=h.id_transaksi;document.getElementById('em_tgl').value=h.tgl;document.getElementById('em_qty').value=h.qty;document.getElementById('em_harga').value=h.harga;document.getElementById('modalEditMasuk').classList.add('active');}}
    async function simpanEditMasuk(){const qty=parseInt(document.getElementById('em_qty').value);const harga=parseInt(document.getElementById('em_harga').value);const d={id_transaksi:document.getElementById('em_id_trx').value,tgl:document.getElementById('em_tgl').value,qty:qty,harga:harga,total:qty*harga};if((await api('update_riwayat_masuk',d)).status==='success'){alert('Update Sukses');tutupModal('modalEditMasuk');loadDataFromServer();}else alert('Gagal');}
    function editRiwayatKeluar(id){const h=historyKeluar.find(x=>x.id_transaksi===id);if(h){document.getElementById('ek_id_trx').value=h.id_transaksi;document.getElementById('ek_tgl').value=h.tgl;document.getElementById('ek_qty').value=h.qty;document.getElementById('ek_ket').value=h.ket;document.getElementById('modalEditKeluar').classList.add('active');}}
    async function simpanEditKeluar(){const d={id_transaksi:document.getElementById('ek_id_trx').value,tgl:document.getElementById('ek_tgl').value,qty:parseInt(document.getElementById('ek_qty').value),ket:document.getElementById('ek_ket').value};if((await api('update_riwayat_keluar',d)).status==='success'){alert('Update Sukses');tutupModal('modalEditKeluar');loadDataFromServer();}else alert('Gagal');}
    async function hapusRiwayatMasuk(id){if(confirm('Hapus?')){await api('hapus_riwayat_masuk',{id:id});loadDataFromServer();}}
    async function hapusRiwayatKeluar(id){if(confirm('Hapus?')){await api('hapus_riwayat_keluar',{id:id});loadDataFromServer();}}
    async function resetData(){if(confirm("RESET SEMUA?")){await api('reset_data');location.reload();}}
    function resetFilterMasuk(){document.getElementById('filter_masuk_keyword').value='';document.getElementById('filter_masuk_start').value='';document.getElementById('filter_masuk_end').value='';renderRiwayatMasuk();}
    function resetFilterKeluar(){document.getElementById('filter_keluar_keyword').value='';document.getElementById('filter_keluar_start').value='';document.getElementById('filter_keluar_end').value='';renderRiwayatKeluar();}
    function cetakPDFMasuk(){const k=document.getElementById('filter_masuk_keyword').value.toLowerCase();const s=document.getElementById('filter_masuk_start').value;const e=document.getElementById('filter_masuk_end').value;const d=historyMasuk.filter(x=>x.nama_barang.toLowerCase().includes(k)&&isDateInRange(x.tgl,s,e));const doc=new jsPDF();doc.text("Laporan Masuk",14,15);doc.autoTable({head:[['Tgl','Nama','Qty','Harga','Total']],body:d.map(x=>[x.tgl,x.nama_barang,x.qty,x.harga,x.total]),startY:30});doc.save('Masuk.pdf');}
    function cetakPDFKeluar(){const k=document.getElementById('filter_keluar_keyword').value.toLowerCase();const s=document.getElementById('filter_keluar_start').value;const e=document.getElementById('filter_keluar_end').value;const d=historyKeluar.filter(x=>x.nama_barang.toLowerCase().includes(k)&&isDateInRange(x.tgl,s,e));const doc=new jsPDF();doc.text("Laporan Keluar",14,15);doc.autoTable({head:[['Tgl','Nama','Qty','Ket']],body:d.map(x=>[x.tgl,x.nama_barang,x.qty,x.ket]),startY:30});doc.save('Keluar.pdf');}
    function cetakPDFLaporan(){const doc=new jsPDF();doc.text("Laporan Stok",14,15);doc.autoTable({head:[['ID','Nama','Stok','Harga','Aset']],body:db.map(r=>[r.id,r.nama,r.stok+' '+r.satuan,formatRupiah(r.harga),formatRupiah(r.stok*r.harga)]),startY:20});doc.save('Stok.pdf');}
</script>
</body>
</html>
